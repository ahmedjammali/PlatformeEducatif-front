<!-- exercise-form.component.html -->
<div class="exercise-form">
  <form [formGroup]="exerciseForm" (ngSubmit)="onSubmit()">

    <!-- Form Progress Indicator -->
    <div class="form-progress" *ngIf="exerciseForm.get('type')?.value">
      <div class="progress-item" [class.completed]="exerciseForm.get('title')?.valid && exerciseForm.get('type')?.valid && exerciseForm.get('subject')?.valid && exerciseForm.get('class')?.valid" 
           [class.error]="(exerciseForm.get('title')?.invalid && exerciseForm.get('title')?.touched) || (exerciseForm.get('type')?.invalid && exerciseForm.get('type')?.touched) || (exerciseForm.get('subject')?.invalid && exerciseForm.get('subject')?.touched) || (exerciseForm.get('class')?.invalid && exerciseForm.get('class')?.touched)"
           [class.pending]="!exerciseForm.get('title')?.touched && !exerciseForm.get('type')?.touched && !exerciseForm.get('subject')?.touched && !exerciseForm.get('class')?.touched">
        <span class="progress-icon">
          <span *ngIf="exerciseForm.get('title')?.valid && exerciseForm.get('type')?.valid && exerciseForm.get('subject')?.valid && exerciseForm.get('class')?.valid">✓</span>
          <span *ngIf="(exerciseForm.get('title')?.invalid && exerciseForm.get('title')?.touched) || (exerciseForm.get('type')?.invalid && exerciseForm.get('type')?.touched) || (exerciseForm.get('subject')?.invalid && exerciseForm.get('subject')?.touched) || (exerciseForm.get('class')?.invalid && exerciseForm.get('class')?.touched)">✕</span>
          <span *ngIf="!exerciseForm.get('title')?.touched && !exerciseForm.get('type')?.touched && !exerciseForm.get('subject')?.touched && !exerciseForm.get('class')?.touched">1</span>
        </span>
        Informations de base
      </div>
      
      <div class="progress-item" [class.completed]="exerciseForm.get('estimatedTime')?.valid && exerciseForm.get('maxAttempts')?.valid" 
           [class.error]="(exerciseForm.get('estimatedTime')?.invalid && exerciseForm.get('estimatedTime')?.touched) || (exerciseForm.get('maxAttempts')?.invalid && exerciseForm.get('maxAttempts')?.touched)"
           [class.pending]="!exerciseForm.get('estimatedTime')?.touched && !exerciseForm.get('maxAttempts')?.touched">
        <span class="progress-icon">
          <span *ngIf="exerciseForm.get('estimatedTime')?.valid && exerciseForm.get('maxAttempts')?.valid">✓</span>
          <span *ngIf="(exerciseForm.get('estimatedTime')?.invalid && exerciseForm.get('estimatedTime')?.touched) || (exerciseForm.get('maxAttempts')?.invalid && exerciseForm.get('maxAttempts')?.touched)">✕</span>
          <span *ngIf="!exerciseForm.get('estimatedTime')?.touched && !exerciseForm.get('maxAttempts')?.touched">2</span>
        </span>
        Paramètres
      </div>
      
      <div class="progress-item" [class.completed]="hasQuestionsValidator()" 
           [class.error]="!hasQuestionsValidator() && (qcmQuestions.length > 0 || fillBlankQuestions.length > 0 || questionValidationError)"
           [class.pending]="!hasQuestionsValidator() && qcmQuestions.length === 0 && fillBlankQuestions.length === 0">
        <span class="progress-icon">
          <span *ngIf="hasQuestionsValidator()">✓</span>
          <span *ngIf="!hasQuestionsValidator() && (qcmQuestions.length > 0 || fillBlankQuestions.length > 0 || questionValidationError)">✕</span>
          <span *ngIf="!hasQuestionsValidator() && qcmQuestions.length === 0 && fillBlankQuestions.length === 0">3</span>
        </span>
        Questions
      </div>
    </div>

    <!-- Informations de base -->
    <div class="form-section">
      <h3 class="form-section-title">Informations de base</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Titre de l'exercice *</label>
          <input 
            type="text" 
            class="form-control" 
            formControlName="title"
            placeholder="Saisissez le titre de l'exercice">
          <div class="error-message" *ngIf="exerciseForm.get('title')?.touched && exerciseForm.get('title')?.errors?.['required']">
            Le titre est requis
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Type d'exercice *</label>
          <select class="form-control" formControlName="type" (change)="onTypeChange()">
            <option value="">Sélectionnez le type</option>
            <option value="qcm">Choix multiples (QCM)</option>
            <option value="fill_blanks">Texte à trous</option>
          </select>
          <div class="error-message" *ngIf="exerciseForm.get('type')?.touched && exerciseForm.get('type')?.errors?.['required']">
            Le type est requis
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Matière *</label>
          <select class="form-control" formControlName="subject" (change)="onSubjectChange()">
            <option value="">Sélectionnez la matière</option>
            <option *ngFor="let subject of subjects" [value]="subject._id!">
              {{ subject.name }}
            </option>
          </select>
          <div class="error-message" *ngIf="exerciseForm.get('subject')?.touched && exerciseForm.get('subject')?.errors?.['required']">
            La matière est requise
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Classe *</label>
          <select class="form-control" formControlName="class">
            <option value="">Sélectionnez la classe</option>
            <option *ngFor="let class of filteredClasses" [value]="class._id!">
              {{ class.name }} - {{ class.grade }}
            </option>
          </select>
          <div class="error-message" *ngIf="exerciseForm.get('class')?.touched && exerciseForm.get('class')?.errors?.['required']">
            La classe est requise
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Niveau de difficulté *</label>
          <div class="difficulty-options">
            <label class="radio-option" [class.selected]="exerciseForm.get('difficulty')?.value === 'easy'">
              <input type="radio" formControlName="difficulty" value="easy">
              <span class="radio-label easy">Facile</span>
            </label>
            <label class="radio-option" [class.selected]="exerciseForm.get('difficulty')?.value === 'medium'">
              <input type="radio" formControlName="difficulty" value="medium">
              <span class="radio-label medium">Moyen</span>
            </label>
            <label class="radio-option" [class.selected]="exerciseForm.get('difficulty')?.value === 'hard'">
              <input type="radio" formControlName="difficulty" value="hard">
              <span class="radio-label hard">Difficile</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Paramètres de l'exercice -->
    <div class="form-section">
      <h3 class="form-section-title">Paramètres de l'exercice</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Consignes</label>
          <textarea 
            class="form-control" 
            formControlName="instructions"
            rows="3"
            placeholder="Fournissez des consignes pour les élèves">
          </textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Temps estimé (minutes) *</label>
          <input 
            type="number" 
            class="form-control" 
            formControlName="estimatedTime"
            placeholder="ex: 30"
            min="1">
          <div class="error-message" *ngIf="exerciseForm.get('estimatedTime')?.touched && exerciseForm.get('estimatedTime')?.errors?.['required']">
            Le temps estimé est requis
          </div>
          <div class="error-message" *ngIf="exerciseForm.get('estimatedTime')?.touched && exerciseForm.get('estimatedTime')?.errors?.['min']">
            Le temps estimé doit être supérieur à 0 minute
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Nombre d'essais maximum *</label>
          <input 
            type="number" 
            class="form-control" 
            formControlName="maxAttempts"
            placeholder="ex: 2"
            min="1">
          <div class="error-message" *ngIf="exerciseForm.get('maxAttempts')?.touched && exerciseForm.get('maxAttempts')?.errors?.['required']">
            Le nombre d'essais maximum est requis
          </div>
          <div class="error-message" *ngIf="exerciseForm.get('maxAttempts')?.touched && exerciseForm.get('maxAttempts')?.errors?.['min']">
            Le nombre d'essais doit être supérieur à 0
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Date limite (Optionnel)</label>
          <input 
            type="datetime-local" 
            class="form-control" 
            formControlName="dueDate">
        </div>
      </div>
    </div>

    <!-- Section des questions -->
    <div class="form-section">
      <div class="section-header">
        <h3 class="form-section-title">Questions *</h3>
        <button type="button" class="add-question-btn" (click)="addQuestion()">
          <span class="btn-icon">➕</span>
          Ajouter une question
        </button>
      </div>

      <!-- Question Counter -->
      <div class="question-counter" 
           [class.empty]="(exerciseForm.get('type')?.value === 'qcm' && qcmQuestions.length === 0) || (exerciseForm.get('type')?.value === 'fill_blanks' && fillBlankQuestions.length === 0)">
        <span class="count">
          {{ exerciseForm.get('type')?.value === 'qcm' ? qcmQuestions.length : 
             exerciseForm.get('type')?.value === 'fill_blanks' ? fillBlankQuestions.length : 0 }}
        </span>
        <span>question{{ (exerciseForm.get('type')?.value === 'qcm' ? qcmQuestions.length : fillBlankQuestions.length) !== 1 ? 's' : '' }} ajoutée{{ (exerciseForm.get('type')?.value === 'qcm' ? qcmQuestions.length : fillBlankQuestions.length) !== 1 ? 's' : '' }}</span>
        <span *ngIf="(exerciseForm.get('type')?.value === 'qcm' && qcmQuestions.length === 0) || (exerciseForm.get('type')?.value === 'fill_blanks' && fillBlankQuestions.length === 0)" class="required-indicator">
          - Au moins 1 requise
        </span>
      </div>



      <!-- Questions QCM -->
      <div *ngIf="exerciseForm.get('type')?.value === 'qcm'" formArrayName="qcmQuestions">
        <div class="question-card" *ngFor="let question of qcmQuestions.controls; let i = index" [formGroupName]="i">
          <div class="question-header">
            <h4 class="question-number">Question {{ i + 1 }}</h4>
            <button type="button" class="remove-btn" (click)="removeQuestion(i)" *ngIf="qcmQuestions.length > 1">
              <span class="remove-icon">✕</span>
            </button>
          </div>

          <div class="form-group">
            <label class="form-label">Texte de la question *</label>
            <textarea 
              class="form-control" 
              formControlName="questionText"
              rows="2"
              placeholder="Saisissez la question">
            </textarea>
            <div class="error-message" *ngIf="question.get('questionText')?.touched && question.get('questionText')?.errors?.['required']">
              Le texte de la question est requis
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Points *</label>
            <input 
              type="number" 
              class="form-control small-input" 
              formControlName="points"
              placeholder="ex: 2"
              min="1">
            <div class="error-message" *ngIf="question.get('points')?.touched && question.get('points')?.errors?.['required']">
              Les points sont requis
            </div>
            <div class="error-message" *ngIf="question.get('points')?.touched && question.get('points')?.errors?.['min']">
              Les points doivent être supérieurs à 0
            </div>
          </div>

          <div class="options-section">
            <label class="form-label">Options *</label>
            <div formArrayName="options">
              <div class="option-item" *ngFor="let option of getOptions(i).controls; let j = index" [formGroupName]="j">
                <input 
                  type="text" 
                  class="form-control option-input" 
                  formControlName="text"
                  placeholder="Saisissez l'option {{ j + 1 }}">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    formControlName="isCorrect"
                    (change)="onCorrectOptionChange(i, j)">
                  <span class="checkbox-custom"></span>
                  Correct
                </label>
                <button type="button" class="remove-option-btn" (click)="removeOption(i, j)" *ngIf="getOptions(i).length > 2">
                  <span class="remove-icon">✕</span>
                </button>
              </div>
              <button type="button" class="add-option-btn" (click)="addOption(i)" *ngIf="getOptions(i).length < 6">
                <span class="btn-icon">➕</span>
                Ajouter une option
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions à trous -->
      <div *ngIf="exerciseForm.get('type')?.value === 'fill_blanks'" formArrayName="fillBlankQuestions">
        <div class="question-card" *ngFor="let question of fillBlankQuestions.controls; let i = index" [formGroupName]="i">
          <div class="question-header">
            <h4 class="question-number">Question {{ i + 1 }}</h4>
            <button type="button" class="remove-btn" (click)="removeQuestion(i)" *ngIf="fillBlankQuestions.length > 1">
              <span class="remove-icon">✕</span>
            </button>
          </div>

          <div class="form-group">
            <label class="form-label">Phrase avec des trous *</label>
            <textarea 
              class="form-control" 
              formControlName="sentence"
              rows="2"
              placeholder="Utilisez ___ pour indiquer les trous (ex: La capitale de la France est ___)">
            </textarea>
            <div class="help-text">Utilisez trois tirets bas (___) pour indiquer où les trous doivent apparaître</div>
            <div class="error-message" *ngIf="question.get('sentence')?.touched && question.get('sentence')?.errors?.['required']">
              La phrase avec des trous est requise
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Points *</label>
            <input 
              type="number" 
              class="form-control small-input" 
              formControlName="points"
              placeholder="ex: 2"
              min="1">
            <div class="error-message" *ngIf="question.get('points')?.touched && question.get('points')?.errors?.['required']">
              Les points sont requis
            </div>
            <div class="error-message" *ngIf="question.get('points')?.touched && question.get('points')?.errors?.['min']">
              Les points doivent être supérieurs à 0
            </div>
          </div>

          <div class="blanks-section" formArrayName="blanks">
            <label class="form-label">Réponses correctes *</label>
            <div class="blank-item" *ngFor="let blank of getBlanks(i).controls; let j = index" [formGroupName]="j">
              <span class="blank-number">Trou {{ j + 1 }}:</span>
              <input 
                type="text" 
                class="form-control blank-input" 
                formControlName="correctAnswer"
                placeholder="Saisissez la réponse correcte">
              <button type="button" class="remove-blank-btn" (click)="removeBlank(i, j)" *ngIf="getBlanks(i).length > 1">
                <span class="remove-icon">✕</span>
              </button>
            </div>
            <button type="button" class="add-blank-btn" (click)="addBlank(i)">
              <span class="btn-icon">➕</span>
              Ajouter un trou
            </button>
          </div>
        </div>
      </div>

      <!-- État vide avec validation message -->
      <div class="empty-questions" *ngIf="(exerciseForm.get('type')?.value === 'qcm' && qcmQuestions.length === 0) || (exerciseForm.get('type')?.value === 'fill_blanks' && fillBlankQuestions.length === 0)">
        <div class="empty-icon">❓</div>
        <p class="empty-text">Aucune question ajoutée pour le moment</p>
        <button type="button" class="add-question-btn" (click)="addQuestion()">
          <span class="btn-icon">➕</span>
          Ajouter votre première question
        </button>
      </div>
    </div>

    <!-- Actions du formulaire -->
    <div class="form-actions">
      <button type="button" class="cancel-btn" (click)="onCancel()">
        Annuler
      </button>
      <button type="submit" class="submit-btn" [disabled]="!isFormValid || isSubmitting">
        <span *ngIf="!isSubmitting">
          {{ isEditMode ? 'Modifier l\'exercice' : 'Créer l\'exercice' }}
        </span>
        <span *ngIf="isSubmitting" class="loading">
          <span class="spinner"></span>
          {{ isEditMode ? 'Modification en cours...' : 'Création en cours...' }}
        </span>
      </button>
    </div>

    
  </form>
</div>