<section class="content-section grades-section">
  <div class="section-header">
    <h2 class="section-title">Gestion des Notes</h2>
    <button 
      class="create-btn"
      (click)="openCreateGradeForm()"
      [disabled]="!filters.selectedClass || !filters.selectedSubject">
      <span class="btn-icon">➕</span>
      Ajouter une Note
    </button>
  </div>

  <!-- Barre de filtres -->
  <div class="filters-bar">
    <div class="filters-header">
      <h3 class="filters-title">

        Filtres
      </h3>
      <button 
        class="reset-filters-btn"
        (click)="resetFilters()"
        [disabled]="!hasActiveFilters()"
        title="Réinitialiser tous les filtres">
        <span class="reset-icon">🔄</span>
        Réinitialiser les filtres
      </button>
    </div>
    
    <div class="filters-container">
      <div class="filter-group primary">
        <label for="class-select">
          Classe *
        </label>
        <div class="filter-input-wrapper">
          <span class="filter-icon">🏫</span>
          <select 
            id="class-select"
            class="filter-select"
            [(ngModel)]="filters.selectedClass"
            (change)="onFilterChange()">
            <option value="">Sélectionner une classe</option>
            <option *ngFor="let class of classes" [value]="class._id">
              {{ class.name }} - {{ class.grade }}
            </option>
          </select>
        </div>
        <small class="filter-help" *ngIf="!filters.selectedClass">
          Sélectionnez une classe pour commencer
        </small>
      </div>

      <div class="filter-group" [class.disabled]="!filters.selectedClass">
        <label for="subject-select">

          Matière
        </label>
        <div class="filter-input-wrapper">
          <span class="filter-icon">📚</span>
          <select 
            id="subject-select"
            class="filter-select"
            [(ngModel)]="filters.selectedSubject"
            (change)="onFilterChange()"
            [disabled]="!filters.selectedClass">
            <option value="">
              {{ !filters.selectedClass ? 'Sélectionnez d\'abord une classe' : 'Toutes les matières' }}
            </option>
            <option *ngFor="let subject of getAvailableSubjects()" [value]="subject._id">
              {{ subject.name }}
            </option>
          </select>
        </div>
        <small class="filter-help" *ngIf="filters.selectedClass && getAvailableSubjects().length === 0">
          Aucune matière assignée dans cette classe
        </small>
      </div>

      <div class="filter-group">
        <label for="trimester-select">
          Trimestre
        </label>
        <div class="filter-input-wrapper">
          <span class="filter-icon">📅</span>
          <select 
            id="trimester-select"
            class="filter-select"
            [(ngModel)]="filters.selectedTrimester"
            (change)="onFilterChange()">
            <option value="">Tous les trimestres</option>
            <option *ngFor="let trimester of trimesters" [value]="trimester">
              {{ trimester }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label for="exam-type-select">
          Type d'examen
        </label>
        <div class="filter-input-wrapper">
          <span class="filter-icon">📝</span>
          <select 
            id="exam-type-select"
            class="filter-select"
            [(ngModel)]="filters.selectedExamType"
            (change)="onFilterChange()">
            <option value="">Tous les types</option>
            <option *ngFor="let examType of examTypes" [value]="examType.value">
              {{ examType.label }}
            </option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Résumé des filtres actifs -->
    <div class="active-filters" *ngIf="hasActiveFilters()">
      <span class="active-filters-label">Filtres actifs:</span>
      <div class="filter-tags">
        <span class="filter-tag" *ngIf="filters.selectedClass">

          {{ getClassName(filters.selectedClass) }}
          <button (click)="clearFilter('class')" class="tag-remove">×</button>
        </span>
        <span class="filter-tag" *ngIf="filters.selectedSubject">
     
          {{ getSubjectName(filters.selectedSubject) }}
          <button (click)="clearFilter('subject')" class="tag-remove">×</button>
        </span>
        <span class="filter-tag" *ngIf="filters.selectedTrimester">

          {{ filters.selectedTrimester }}
          <button (click)="clearFilter('trimester')" class="tag-remove">×</button>
        </span>
        <span class="filter-tag" *ngIf="filters.selectedExamType">

          {{ getExamTypeLabel(filters.selectedExamType) }}
          <button (click)="clearFilter('examType')" class="tag-remove">×</button>
        </span>
      </div>
    </div>
  </div>

  <!-- Basculement du mode d'affichage -->
  <div class="view-toggle" *ngIf="filteredGrades.length > 0">
    <button 
      class="toggle-btn"
      [class.active]="viewMode === 'table'"
      (click)="onViewModeChange('table')">
      <span class="btn-icon">📊</span>
      Vue Cartes
    </button>
    <button 
      class="toggle-btn"
      [class.active]="viewMode === 'students'"
      (click)="onViewModeChange('students')">
      <span class="btn-icon">👥</span>
      Vue Étudiants
    </button>
  </div>

  <!-- État de chargement -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Chargement des notes...</p>
  </div>

  <!-- Message aucune classe sélectionnée -->
  <div class="empty-state" *ngIf="!filters.selectedClass && !isLoading">
    <div class="empty-icon">🏫</div>
    <h3 class="empty-title">Sélectionnez une classe</h3>
    <p class="empty-text">Veuillez sélectionner une classe pour voir les notes.</p>
  </div>

  <!-- Message aucune note -->
  <div class="empty-state" *ngIf="filters.selectedClass && filteredGrades.length === 0 && !isLoading">
    <div class="empty-icon">📊</div>
    <h3 class="empty-title">Aucune note trouvée</h3>
    <p class="empty-text">Aucune note ne correspond aux critères sélectionnés.</p>
    <button class="create-btn" (click)="openCreateGradeForm()">
      <span class="btn-icon">➕</span>
      Ajouter la première note
    </button>
  </div>

  <!-- Vue Cartes -->
  <div class="grades-list" *ngIf="viewMode === 'table' && filteredGrades.length > 0 && !isLoading">
    <div class="grade-card" *ngFor="let grade of filteredGrades">
      <div class="grade-header">
        <h3 class="grade-title">{{ grade.examName }}</h3>
        <span class="exam-type-badge" [attr.data-type]="grade.examType">
          {{ getExamTypeLabel(grade.examType) }}
        </span>
      </div>
      <div class="grade-meta">
        <span class="meta-item">
          <span class="meta-icon">👤</span>
          {{ getStudentName(grade.student) }}
        </span>
        <span class="meta-item">
          <span class="meta-icon">📚</span>
          {{ getSubjectName(grade.subject) }}
        </span>
        <span class="meta-item">
          <span class="meta-icon">📅</span>
          {{ grade.trimester }}
        </span>
        <span class="meta-item">
          <span class="meta-icon">📊</span>
          Coefficient {{ grade.coefficient }}
        </span>
      </div>
      <div class="grade-stats">
        <div class="stat">
          <span class="stat-label">Note obtenue:</span>
          <span class="stat-value grade-value" [ngClass]="getGradeClass(grade.grade)">
            {{ grade.grade }}/20
          </span>
        </div>
        <div class="stat">
          <span class="stat-label">Date d'examen:</span>
          <span class="stat-value">{{ grade.examDate | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
      <div class="grade-actions">
        <button 
          class="action-btn edit-btn"
          (click)="editGrade(grade)"
          title="Modifier">
          <span class="btn-icon">✏️</span>
          Modifier
        </button>
        <button 
          class="action-btn delete-btn"
          (click)="openDeleteConfirmation(grade)"
          title="Supprimer">
          <span class="btn-icon">🗑️</span>
          Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- Vue Étudiants -->
  <div class="students-view" *ngIf="viewMode === 'students' && studentGradeSummaries.length > 0 && !isLoading">
    <div class="students-grid">
      <div class="student-card" *ngFor="let summary of studentGradeSummaries">
        <div class="student-header">
          <div class="student-avatar">
            {{ getStudentName(summary.student).charAt(0) }}
          </div>
          <div class="student-details">
            <h3>{{ getStudentName(summary.student) }}</h3>
            <p class="student-email">{{ summary.student.email }}</p>
          </div>
          <div class="student-stats">
            <div class="stat">
              <span class="stat-value grade-value" [ngClass]="getGradeClass(summary.average)">
                {{ summary.average | number:'1.2-2' }}
              </span>
              <span class="stat-label">Moyenne</span>
            </div>
            <div class="stat">
              <span class="stat-value">{{ summary.totalGrades }}</span>
              <span class="stat-label">Notes</span>
            </div>
          </div>
        </div>
        <div class="student-grades">
          <div class="grade-item" *ngFor="let grade of summary.grades">
            <div class="grade-info">
              <span class="grade-exam">{{ grade.examName }}</span>
              <span class="grade-type">{{ getExamTypeLabel(grade.examType) }}</span>
            </div>
            <div class="grade-score">
              <span class="grade-value" [ngClass]="getGradeClass(grade.grade)">
                {{ grade.grade }}/20
              </span>
              <span class="grade-coeff">Coeff. {{ grade.coefficient }}</span>
            </div>
            <div class="grade-actions">
              <button class="action-btn edit-btn" (click)="editGrade(grade)">
                <span class="btn-icon">✏️</span>
              </button>
              <button class="action-btn delete-btn" (click)="openDeleteConfirmation(grade)">
                <span class="btn-icon">🗑️</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal du formulaire de création/modification de note -->
  <div class="modal-overlay" *ngIf="showCreateForm" (click)="cancelForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">{{ editingGrade ? 'Modifier la Note' : 'Ajouter une Note' }}</h2>
        <button class="close-btn" (click)="cancelForm()">✕</button>
      </div>

      <div class="modal-body">
        <form class="grade-form" (ngSubmit)="saveGrade()">
          <div class="form-grid">
            <div class="form-group">
              <label for="student-select">Étudiant *</label>
              <select 
                id="student-select"
                class="form-select"
                [(ngModel)]="gradeForm.studentId"
                name="studentId"
                required
                [disabled]="!!editingGrade">
                <option value="">Sélectionner un étudiant</option>
                <option *ngFor="let student of getStudentsForSelectedClass()" [value]="student._id">
                  {{ getStudentName(student) }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="subject-form-select">Matière *</label>
              <select 
                id="subject-form-select"
                class="form-select"
                [(ngModel)]="gradeForm.subjectId"
                name="subjectId"
                required
                [disabled]="!!editingGrade || !filters.selectedClass">
                <option value="">
                  {{ !filters.selectedClass ? 'Sélectionnez d\'abord une classe' : 'Sélectionner une matière' }}
                </option>
                <option *ngFor="let subject of getAvailableSubjects()" [value]="subject._id">
                  {{ subject.name }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="exam-name">Nom de l'examen *</label>
              <input 
                id="exam-name"
                type="text"
                class="form-input"
                [(ngModel)]="gradeForm.examName"
                name="examName"
                placeholder="Ex: Contrôle de Mathématiques"
                required
                [disabled]="!!editingGrade">
            </div>

            <div class="form-group">
              <label for="exam-type-form">Type d'examen *</label>
              <select 
                id="exam-type-form"
                class="form-select"
                [(ngModel)]="gradeForm.examType"
                name="examType"
                required
                [disabled]="!!editingGrade">
                <option *ngFor="let examType of examTypes" [value]="examType.value">
                  {{ examType.label }}
                </option>
              </select>
            </div>

           <div class="form-group">
            <label for="grade-value">Note */20 *</label>
            <input 
              id="grade-value"
              type="number"
              class="form-input"
              [class.error]="gradeInputTouched && gradeValidationError"
              [(ngModel)]="gradeForm.grade"
              name="grade"
              min="0"
              max="20"
              step="0.5"
              required
              (input)="onGradeInput()"
              (blur)="onGradeInput()"
              placeholder="Saisir une note entre 0 et 20">
            
            <!-- Error message display -->
            <div class="validation-error" *ngIf="gradeInputTouched && gradeValidationError">
              <span class="error-icon">⚠️</span>
              <span class="error-message">{{ gradeValidationError }}</span>
            </div>
            
            <!-- Helper text when no error -->
            <small class="input-help" *ngIf="!gradeValidationError">
              La note doit être comprise entre 0 et 20
            </small>
          </div>

            <div class="form-group">
              <label for="coefficient">Coefficient *</label>
              <input 
                id="coefficient"
                type="number"
                class="form-input"
                [(ngModel)]="gradeForm.coefficient"
                name="coefficient"
                min="1"
                max="10"
                required
                [disabled]="!!editingGrade">
            </div>

            <div class="form-group">
              <label for="exam-date">Date de l'examen</label>
              <input 
                id="exam-date"
                type="date"
                class="form-input"
                [(ngModel)]="gradeForm.examDate"
                name="examDate"
                [disabled]="!!editingGrade">
            </div>

            <div class="form-group">
              <label for="trimester-form">Trimestre *</label>
              <select 
                id="trimester-form"
                class="form-select"
                [(ngModel)]="gradeForm.trimester"
                name="trimester"
                required
                [disabled]="!!editingGrade">
                <option *ngFor="let trimester of trimesters" [value]="trimester">
                  {{ trimester }}
                </option>
              </select>
            </div>
          </div>

          <div class="form-group full-width">
            <label for="comments">Commentaires</label>
            <textarea 
              id="comments"
              class="form-textarea"
              [(ngModel)]="gradeForm.comments"
              name="comments"
              placeholder="Commentaires sur la note..."
              rows="3"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="cancelForm()">
              Annuler
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="!isFormValid() || isLoading"
              [class.disabled]="!isFormValid() || isLoading">
              <span *ngIf="isLoading" class="button-spinner"></span>
              <span *ngIf="!isLoading" class="btn-icon">
                {{ editingGrade ? '✏️' : '➕' }}
              </span>
              {{ editingGrade ? 'Mettre à jour' : 'Créer la Note' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div class="modal-overlay delete-modal-overlay" *ngIf="showDeleteConfirmation" (click)="cancelDeleteConfirmation()">
    <div class="modal-content delete-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header delete-modal-header">
        <div class="delete-icon-container">
          <span class="warning-icon">⚠️</span>
        </div>
        <h3>Confirmer la suppression</h3>
        <button class="close-btn" (click)="cancelDeleteConfirmation()">✕</button>
      </div>

      <div class="delete-modal-body">
        <div class="delete-warning-message">
          <p>Êtes-vous sûr de vouloir supprimer cette note ?</p>
          <p class="warning-text">Cette action est irréversible.</p>
        </div>

        <!-- Détails de la note pour confirmation -->
        <div class="grade-details-card" *ngIf="gradeToDelete">
          <div class="grade-detail-row">
            <span class="detail-label">Étudiant:</span>
            <span class="detail-value">{{ getStudentName(gradeToDelete.student) }}</span>
          </div>
          <div class="grade-detail-row">
            <span class="detail-label">Matière:</span>
            <span class="detail-value">{{ getSubjectName(gradeToDelete.subject) }}</span>
          </div>
          <div class="grade-detail-row">
            <span class="detail-label">Examen:</span>
            <span class="detail-value">{{ gradeToDelete.examName }}</span>
          </div>
          <div class="grade-detail-row">
            <span class="detail-label">Type:</span>
            <span class="detail-value">{{ getExamTypeLabel(gradeToDelete.examType) }}</span>
          </div>
          <div class="grade-detail-row">
            <span class="detail-label">Note:</span>
            <span class="detail-value grade-highlight" [ngClass]="getGradeClass(gradeToDelete.grade)">
              {{ gradeToDelete.grade }}/20
            </span>
          </div>
          <div class="grade-detail-row">
            <span class="detail-label">Trimestre:</span>
            <span class="detail-value">{{ gradeToDelete.trimester }}</span>
          </div>
        </div>
      </div>

      <div class="delete-modal-actions">
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="cancelDeleteConfirmation()"
          [disabled]="isDeleting">
          Annuler
        </button>
        <button 
          type="button" 
          class="btn btn-danger" 
          (click)="confirmDeleteGrade()"
          [disabled]="isDeleting">
          <span *ngIf="isDeleting" class="delete-spinner"></span>
          <span *ngIf="!isDeleting" class="btn-icon">🗑️</span>
          {{ isDeleting ? 'Suppression...' : 'Supprimer' }}
        </button>
      </div>
    </div>
  </div>
</section>