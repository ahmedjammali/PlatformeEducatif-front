<section class="content-section">
  <h2 class="section-title">Progr√®s des √©l√®ves</h2>
  
  <!-- √âtat de chargement -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des donn√©es de progr√®s...</p>
  </div>

  <!-- Contenu principal -->
  <div *ngIf="!isLoading" class="progress-container">
    
    <!-- Section des filtres -->
    <div class="filters-section">
      <h3>Filtres</h3>
      <div class="filters-grid">
        <div class="filter-group">
          <label for="classFilter">Classe</label>
          <select id="classFilter" [(ngModel)]="selectedClass" (change)="onClassFilterChange()" class="filter-select">
            <option value="">Toutes les classes</option>
            <option *ngFor="let class of myClasses" [value]="class._id">{{class?.name}} - {{class?.grade}}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="subjectFilter">Mati√®re</label>
          <select id="subjectFilter" [(ngModel)]="selectedSubject" (change)="applyFilters()" class="filter-select">
            <option value="">Toutes les mati√®res</option>
            <option *ngFor="let subject of teachingSubjects" [value]="subject._id">{{subject?.name}}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="exerciseFilter">Exercice</label>
          <select id="exerciseFilter" [(ngModel)]="selectedExercise" (change)="applyFilters()" class="filter-select">
            <option value="">Tous les exercices</option>
            <option *ngFor="let exercise of getFilteredExercises()" [value]="exercise._id">{{exercise?.title}}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="studentFilter">√âl√®ve</label>
          <select id="studentFilter" [(ngModel)]="selectedStudent" (change)="onStudentFilterChange()" class="filter-select">
            <option value="">Tous les √©l√®ves</option>
            <option *ngFor="let student of getFilteredStudents()" [value]="student._id">{{student?.name}}</option>
          </select>
        </div>
      </div>
      
      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="clearFilters()">Effacer les filtres</button>
        <button class="btn btn-primary" (click)="applyFilters()">Appliquer les filtres</button>
      </div>
    </div>

    <!-- Navigation des onglets -->
    <div class="tabs-navigation">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'overview'"
        (click)="activeTab = 'overview'">
        Aper√ßu
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'students'"
        (click)="activeTab = 'students'">
        Progr√®s des √©l√®ves
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'exercises'"
        (click)="activeTab = 'exercises'">
        Analyses d'exercices
      </button>
    </div>

    <!-- Onglet Aper√ßu -->
    <div *ngIf="activeTab === 'overview'" class="tab-content">
      <div class="overview-stats">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-content">
            <h4>Total √©l√®ves</h4>
            <p class="stat-number">{{filteredStudentsProgressData.length}}</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìö</div>
          <div class="stat-content">
            <h4>Mes exercices</h4>
            <p class="stat-number">{{teacherExercises.length}}</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div class="stat-content">
            <h4>Score moyen</h4>
            <p class="stat-number">{{averageScore.toFixed(1)}}%</p>
          </div>
        </div>
      </div>

      <!-- Aper√ßu rapide des classes -->
      <div class="class-overview">
        <h3>Aper√ßu des performances par classe</h3>
        <div class="class-cards">
          <div *ngFor="let class of myClasses" class="class-card">
            <h4>{{class.name}} - {{class.grade}}</h4>
            <div class="class-stats">
              <div class="class-stat">
                <span class="label">√âl√®ves:</span>
                <span class="value">{{class.students?.length || 0}}</span>
              </div>
              <div class="class-stat">
                <span class="label">Mes exercices:</span>
                <span class="value">{{getExerciseCountForClass(class._id!)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Onglet Progr√®s des √©l√®ves -->
    <div *ngIf="activeTab === 'students'" class="tab-content">
      <div class="students-header">
        <h3>Progr√®s des √©l√®ves ({{filteredStudentsProgressData.length}} {{filteredStudentsProgressData.length === 1 ? '√©l√®ve' : '√©l√®ves'}})</h3>
        <div class="sort-controls">
          <label>Trier par:</label>
          <select [(ngModel)]="sortBy" (change)="sortStudentsData()" class="sort-select">
            <option value="name">Nom</option>
            <option value="score">Score moyen</option>
            <option value="completedExercises">Exercices termin√©s</option>
            <option value="timeSpent">Temps pass√©</option>
          </select>
          <button class="sort-direction-btn" (click)="setSortBy(sortBy)">
            {{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}
          </button>
        </div>
      </div>

      <div class="students-grid">
        <div *ngFor="let studentData of filteredStudentsProgressData" class="student-card">
          <div class="student-header">
            <div class="student-info">
              <h4>{{studentData.student.name}}</h4>
              <p>{{studentData.student.email}}</p>
            </div>
            <div class="student-score" [ngClass]="getScoreColor(studentData.overallStats.averageScore)">
              {{studentData.overallStats.averageScore.toFixed(1)}}%
            </div>
          </div>

          <div class="student-stats">
            <div class="stat">
              <span class="stat-label">Termin√©s:</span>
              <span class="stat-value">
                {{studentData.overallStats.completedExercises}}/{{studentData.overallStats.totalExercises}}
              </span>
            </div>
            <div class="stat">
              <span class="stat-label">Taux de r√©ussite:</span>
              <span class="stat-value">
                {{getCompletionRate(studentData.overallStats.completedExercises, studentData.overallStats.totalExercises).toFixed(1)}}%
              </span>
            </div>
            <div class="stat">
              <span class="stat-label">Temps total:</span>
              <span class="stat-value">{{formatTime(studentData.overallStats.totalTimeSpent)}}</span>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill" 
                 [style.width.%]="getCompletionRate(studentData.overallStats.completedExercises, studentData.overallStats.totalExercises)">
            </div>
          </div>

          <!-- D√©tails des exercices -->
          <div class="student-exercises">
            <h5>Progr√®s par exercice</h5>
            <div class="exercises-list">
              <div *ngFor="let exercise of studentData.exercises" class="exercise-item">
                <div class="exercise-info" (click)="exercise._id && toggleExerciseDetails(exercise._id)" style="cursor: pointer;">
                  <div class="exercise-header">
                    <span class="exercise-title">{{getExerciseTitle(exercise)}}</span>
                    <span class="exercise-type">{{toTitleCase(getExerciseType(exercise))}}</span>
                    <span class="expand-icon" *ngIf="exercise._id">{{isExerciseExpanded(exercise._id) ? '‚ñº' : '‚ñ∂'}}</span>
                  </div>
                  <div class="exercise-progress">
                    <span class="score" [ngClass]="getScoreColor(exercise.accuracyPercentage)">
                      {{exercise.accuracyPercentage?.toFixed(1) || 0}}%
                    </span>
                    <span class="attempts">Tentative {{exercise.attemptNumber || 1}}</span>
                  </div>
                </div>
                
                <!-- R√©sultats d√©taill√©s de l'exercice - extensible -->
                <div class="exercise-details" *ngIf="exercise._id && isExerciseExpanded(exercise._id)">
                  
                  <!-- R√©sultats QCM -->
                  <div *ngIf="exercise.qcmAnswers && exercise.qcmAnswers.length > 0">
                    <h6>R√©sultats QCM:</h6>
                    <div class="qcm-results">
                      <div *ngFor="let answer of exercise.qcmAnswers" class="qcm-answer">
                        <span class="question-number">Q{{answer.questionIndex + 1}}:</span>
                        <span class="answer-status" [ngClass]="answer.isCorrect ? 'correct' : 'incorrect'">
                          {{answer.isCorrect ? '‚úì' : '‚úó'}}
                        </span>
                        <span class="points">{{answer.pointsEarned}} pts</span>
                      </div>
                    </div>
                  </div>

                  <!-- R√©sultats Texte √† trous -->
                  <div *ngIf="exercise.fillBlankAnswers && exercise.fillBlankAnswers.length > 0">
                    <h6>R√©sultats Texte √† trous:</h6>
                    <div class="fill-blanks-results">
                      <div *ngFor="let questionAnswer of exercise.fillBlankAnswers; let i = index" class="fill-blank-question">
                        <div class="question-header">
                          <span class="question-number">Question {{questionAnswer.questionIndex + 1}}:</span>
                          <span class="question-points">{{questionAnswer.pointsEarned}} pts</span>
                        </div>
                        <div class="blank-answers">
                          <div *ngFor="let blankAnswer of questionAnswer.blankAnswers" class="blank-answer">
                            <span class="blank-label">Trou {{blankAnswer.blankIndex + 1}}:</span>
                            <span class="student-answer" [ngClass]="blankAnswer.isCorrect ? 'correct' : 'incorrect'">
                              "{{blankAnswer.studentAnswer}}"
                            </span>
                            <span class="answer-status" [ngClass]="blankAnswer.isCorrect ? 'correct' : 'incorrect'">
                              {{blankAnswer.isCorrect ? '‚úì' : '‚úó'}}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- R√©sum√© de l'exercice -->
                  <div class="exercise-summary">
                    <span>Total: {{exercise.totalPointsEarned}}/{{exercise.maxPossiblePoints}} points</span>
                    <span>Temps: {{formatTime(exercise.timeSpent)}}</span>
                    <span>Termin√©: {{exercise.completedAt | date:'short'}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- √âtat vide pour l'onglet √âl√®ves -->
      <div *ngIf="filteredStudentsProgressData.length === 0 && !isLoading" class="empty-state">
        <div class="empty-icon">üë•</div>
        <h3>Aucun √©l√®ve trouv√©</h3>
        <p *ngIf="selectedStudent">Aucune donn√©e de progr√®s trouv√©e pour l'√©l√®ve s√©lectionn√©. Essayez de s√©lectionner un autre √©l√®ve ou d'effacer les filtres.</p>
        <p *ngIf="!selectedStudent">Aucune donn√©e de progr√®s d'√©l√®ve disponible pour les filtres s√©lectionn√©s. Essayez d'ajuster vos filtres ou assurez-vous que les √©l√®ves ont soumis des exercices.</p>
      </div>
    </div>

    <!-- Onglet Analyses d'exercices -->
    <div *ngIf="activeTab === 'exercises'" class="tab-content">
      <h3>Analyses de mes exercices</h3>
      
      <div class="exercises-analytics">
        <div *ngFor="let analyticsData of exerciseAnalytics" class="exercise-analytics-card">
          <div class="exercise-header">
            <h4>{{analyticsData.exercise?.title || 'Exercice inconnu'}}</h4>
            <div class="exercise-meta">
              <span class="exercise-type">{{toTitleCase(analyticsData.exercise?.type || 'inconnu')}}</span>
              <span class="exercise-difficulty">Exercice</span>
            </div>
          </div>

          <div class="analytics-grid">
            <div class="analytic-item">
              <span class="analytic-label">Total soumissions:</span>
              <span class="analytic-value">{{analyticsData.analytics?.overall?.totalSubmissions || 0}}</span>
            </div>
            <div class="analytic-item">
              <span class="analytic-label">Score moyen:</span>
              <span class="analytic-value" [ngClass]="getScoreColor(analyticsData.analytics?.overall?.averageScore || 0)">
                {{(analyticsData.analytics?.overall?.averageScore || 0).toFixed(1)}}%
              </span>
            </div>
            <div class="analytic-item">
              <span class="analytic-label">√âl√®ves uniques:</span>
              <span class="analytic-value">{{analyticsData.analytics?.overall?.uniqueStudents || 0}}</span>
            </div>
            <div class="analytic-item">
              <span class="analytic-label">Temps moyen pass√©:</span>
              <span class="analytic-value">{{formatTime(analyticsData.analytics?.overall?.averageTimeSpent || 0)}}</span>
            </div>
          </div>

          <div class="exercise-details">
            <div class="detail-item">
              <span class="detail-label">Points totaux:</span>
              <span class="detail-value">{{analyticsData.exercise?.totalPoints || 0}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- √âtat vide pour l'onglet Exercices -->
      <div *ngIf="exerciseAnalytics.length === 0 && !isLoading" class="empty-state">
        <div class="empty-icon">üìä</div>
        <h3>Aucune analyse d'exercice</h3>
        <p>Vous n'avez pas encore cr√©√© d'exercices ou aucun √©l√®ve ne les a soumis.</p>
      </div>
    </div>

    <!-- √âtat vide g√©n√©ral -->
    <div *ngIf="!isLoading && studentsProgressData.length === 0 && activeTab === 'overview'" class="empty-state">
      <div class="empty-icon">üìä</div>
      <h3>Aucune donn√©e de progr√®s trouv√©e</h3>
      <p>Aucune donn√©e de progr√®s d'√©l√®ve disponible. Cela pourrait signifier:</p>
      <ul style="text-align: left; max-width: 400px; margin: 1rem auto;">
        <li>Vous n'avez pas encore cr√©√© d'exercices</li>
        <li>Les √©l√®ves n'ont soumis aucun de vos exercices</li>
        <li>Il n'y a pas d'√©l√®ves dans vos classes</li>
      </ul>
    </div>
  </div>
</section>