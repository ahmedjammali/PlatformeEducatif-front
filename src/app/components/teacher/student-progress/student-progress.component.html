<section class="content-section progress-section">
  <div class="section-header">
    <h2 class="section-title">Progrès des élèves</h2>
  </div>

  <!-- État de chargement -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des données de progrès...</p>
  </div>

  <!-- Contenu principal -->
  <div *ngIf="!isLoading" class="progress-container">
    
    <!-- Barre de filtres -->
    <div class="filters-bar">
      <div class="filters-header">
        <h3 class="filters-title">
          Filtres
        </h3>
        <button 
          class="reset-filters-btn"
          (click)="clearFilters()"
          title="Réinitialiser tous les filtres">
          <span class="reset-icon">🔄</span>
          Effacer les filtres
        </button>
      </div>
      
      <div class="filters-container">
        <div class="filter-group primary">
          <label for="classFilter">
            Classe
          </label>
          <div class="filter-input-wrapper">
            <span class="filter-icon">🏫</span>
            <select 
              id="classFilter" 
              class="filter-select"
              [(ngModel)]="selectedClass" 
              (change)="onClassFilterChange()">
              <option value="">Toutes les classes</option>
              <option *ngFor="let class of myClasses" [value]="class._id">
                {{ class?.name }} - {{ class?.grade }}
              </option>
            </select>
          </div>
        </div>

        <div class="filter-group">
          <label for="subjectFilter">
            Matière
          </label>
          <div class="filter-input-wrapper">
            <span class="filter-icon">📚</span>
            <select 
              id="subjectFilter" 
              class="filter-select"
              [(ngModel)]="selectedSubject" 
              (change)="applyFilters()">
              <option value="">Toutes les matières</option>
              <option *ngFor="let subject of teachingSubjects" [value]="subject._id">
                {{ subject?.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="filter-group">
          <label for="exerciseFilter">
            Exercice
          </label>
          <div class="filter-input-wrapper">
            <span class="filter-icon">📝</span>
            <select 
              id="exerciseFilter" 
              class="filter-select"
              [(ngModel)]="selectedExercise" 
              (change)="applyFilters()">
              <option value="">Tous les exercices</option>
              <option *ngFor="let exercise of getFilteredExercises()" [value]="exercise._id">
                {{ exercise?.title }}
              </option>
            </select>
          </div>
        </div>

        <div class="filter-group">
          <label for="studentFilter">
            Élève
          </label>
          <div class="filter-input-wrapper">
            <span class="filter-icon">👤</span>
            <select 
              id="studentFilter" 
              class="filter-select"
              [(ngModel)]="selectedStudent" 
              (change)="onStudentFilterChange()">
              <option value="">Tous les élèves</option>
              <option *ngFor="let student of getFilteredStudents()" [value]="student._id">
                {{ student?.name }}
              </option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation des onglets -->
    <div class="view-toggle">
      <button 
        class="toggle-btn"
        [class.active]="activeTab === 'overview'"
        (click)="activeTab = 'overview'">
        <span class="btn-icon">📈</span>
        Aperçu
      </button>
      <button 
        class="toggle-btn"
        [class.active]="activeTab === 'students'"
        (click)="activeTab = 'students'">
        <span class="btn-icon">👥</span>
        Progrès des élèves
      </button>
      <button 
        class="toggle-btn"
        [class.active]="activeTab === 'exercises'"
        (click)="activeTab = 'exercises'">
        <span class="btn-icon">📊</span>
        Analyses d'exercices
      </button>
    </div>

    <!-- Onglet Aperçu -->
    <div *ngIf="activeTab === 'overview'" class="tab-content">
      <div class="overview-stats">
        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-icon">👥</span>
            <h4 class="stat-title">Total élèves</h4>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ filteredStudentsProgressData.length }}</span>
            <span class="stat-label">élèves actifs</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-icon">📚</span>
            <h4 class="stat-title">Mes exercices</h4>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ teacherExercises.length }}</span>
            <span class="stat-label">exercices créés</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-icon">🎯</span>
            <h4 class="stat-title">Score moyen</h4>
          </div>
          <div class="stat-content">
            <span class="stat-number" [ngClass]="getScoreColor(averageScore)">{{ averageScore.toFixed(1) }}%</span>
            <span class="stat-label">performance globale</span>
          </div>
        </div>
      </div>

      <!-- Aperçu rapide des classes -->
      <div class="class-overview">
        <h3 class="section-subtitle">Aperçu des performances par classe</h3>
        <div class="class-cards">
          <div *ngFor="let class of myClasses" class="class-card">
            <div class="class-header">
              <h4 class="class-title">{{ class.name }} - {{ class.grade }}</h4>
              <span class="class-badge">{{ class.students?.length || 0 }} élèves</span>
            </div>
            <div class="class-stats">
              <div class="class-stat">
                <span class="stat-value">{{ getExerciseCountForClass(class._id!) }}</span>
                <span class="stat-label">Mes exercices</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Onglet Progrès des élèves -->
    <div *ngIf="activeTab === 'students'" class="tab-content">
      <div class="students-header">
        <h3 class="section-subtitle">
          Progrès des élèves ({{ filteredStudentsProgressData.length }} 
          {{ filteredStudentsProgressData.length === 1 ? 'élève' : 'élèves' }})
        </h3>
        <div class="sort-controls">
          <label class="sort-label">Trier par:</label>
          <div class="sort-input-wrapper">
            <select [(ngModel)]="sortBy" (change)="sortStudentsData()" class="sort-select">
              <option value="name">Nom</option>
              <option value="score">Score moyen</option>
              <option value="completedExercises">Exercices terminés</option>
              <option value="timeSpent">Temps passé</option>
            </select>
            <button class="sort-direction-btn" (click)="setSortBy(sortBy)">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </button>
          </div>
        </div>
      </div>

      <div class="students-list">
        <div *ngFor="let studentData of filteredStudentsProgressData" class="student-card">
          <div class="student-header">
            <div class="student-avatar">
              {{ studentData.student.name.charAt(0) }}
            </div>
            <div class="student-info">
              <h4 class="student-name">{{ studentData.student.name }}</h4>
              <p class="student-email">{{ studentData.student.email }}</p>
            </div>
            <div class="student-score" [ngClass]="getScoreColor(studentData.overallStats.averageScore)">
              {{ studentData.overallStats.averageScore.toFixed(1) }}%
            </div>
          </div>

          <div class="student-meta">
            <span class="meta-item">
              <span class="meta-icon">✅</span>
              {{ studentData.overallStats.completedExercises }}/{{ studentData.overallStats.totalExercises }} terminés
            </span>
            <span class="meta-item">
              <span class="meta-icon">📊</span>
              {{ getCompletionRate(studentData.overallStats.completedExercises, studentData.overallStats.totalExercises).toFixed(1) }}% de réussite
            </span>
            <span class="meta-item">
              <span class="meta-icon">⏱️</span>
              {{ formatTime(studentData.overallStats.totalTimeSpent) }} total
            </span>
          </div>

          <div class="progress-bar">
            <div class="progress-fill" 
                 [style.width.%]="getCompletionRate(studentData.overallStats.completedExercises, studentData.overallStats.totalExercises)">
            </div>
          </div>

          <!-- Détails des exercices -->
          <div class="student-exercises">
            <h5 class="exercises-title">Progrès par exercice</h5>
            <div class="exercises-grid">
              <div *ngFor="let exercise of studentData.exercises" class="exercise-item" 
                   (click)="exercise._id && toggleExerciseDetails(exercise._id)">
                <div class="exercise-header">
                  <div class="exercise-info">
                    <span class="exercise-title">{{ getExerciseTitle(exercise) }}</span>
                    <span class="exercise-type" [class]="getExerciseType(exercise)">
                      {{ toTitleCase(getExerciseType(exercise)) }}
                    </span>
                  </div>
                  <div class="exercise-progress">
                    <span class="exercise-score" [ngClass]="getScoreColor(exercise.accuracyPercentage)">
                      {{ exercise.accuracyPercentage?.toFixed(1) || 0 }}%
                    </span>
                    <span class="exercise-attempts">Tentative {{ exercise.attemptNumber || 1 }}</span>
                  </div>
                  <span class="expand-icon" *ngIf="exercise._id">
                    {{ isExerciseExpanded(exercise._id) ? '▼' : '▶' }}
                  </span>
                </div>
                
                <!-- Résultats détaillés de l'exercice -->
                <div class="exercise-details" *ngIf="exercise._id && isExerciseExpanded(exercise._id)">
                  
                  <!-- Résultats QCM -->
                  <div *ngIf="exercise.qcmAnswers && exercise.qcmAnswers.length > 0" class="results-section">
                    <h6 class="results-title">Résultats QCM:</h6>
                    <div class="qcm-results">
                      <div *ngFor="let answer of exercise.qcmAnswers" class="qcm-answer">
                        <span class="question-number">Q{{ answer.questionIndex + 1 }}</span>
                        <span class="answer-status" [class.correct]="answer.isCorrect" [class.incorrect]="!answer.isCorrect">
                          {{ answer.isCorrect ? '✓' : '✗' }}
                        </span>
                        <span class="points">{{ answer.pointsEarned }} pts</span>
                      </div>
                    </div>
                  </div>

                  <!-- Résultats Texte à trous -->
                  <div *ngIf="exercise.fillBlankAnswers && exercise.fillBlankAnswers.length > 0" class="results-section">
                    <h6 class="results-title">Résultats Texte à trous:</h6>
                    <div class="fill-blanks-results">
                      <div *ngFor="let questionAnswer of exercise.fillBlankAnswers; let i = index" class="fill-blank-question">
                        <div class="question-header">
                          <span class="question-number">Question {{ questionAnswer.questionIndex + 1 }}</span>
                          <span class="question-points">{{ questionAnswer.pointsEarned }} pts</span>
                        </div>
                        <div class="blank-answers">
                          <div *ngFor="let blankAnswer of questionAnswer.blankAnswers" class="blank-answer">
                            <span class="blank-label">Trou {{ blankAnswer.blankIndex + 1 }}:</span>
                            <span class="student-answer" [class.correct]="blankAnswer.isCorrect" [class.incorrect]="!blankAnswer.isCorrect">
                              "{{ blankAnswer.studentAnswer }}"
                            </span>
                            <span class="answer-status" [class.correct]="blankAnswer.isCorrect" [class.incorrect]="!blankAnswer.isCorrect">
                              {{ blankAnswer.isCorrect ? '✓' : '✗' }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Résumé de l'exercice -->
                  <div class="exercise-summary">
                    <span class="summary-item">
                      <span class="summary-icon">🎯</span>
                      {{ exercise.totalPointsEarned }}/{{ exercise.maxPossiblePoints }} points
                    </span>
                    <span class="summary-item">
                      <span class="summary-icon">⏱️</span>
                      {{ formatTime(exercise.timeSpent) }}
                    </span>
                    <span class="summary-item">
                      <span class="summary-icon">📅</span>
                      {{ exercise.completedAt | date:'short' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- État vide pour l'onglet Élèves -->
      <div *ngIf="filteredStudentsProgressData.length === 0 && !isLoading" class="empty-state">
        <div class="empty-icon">👥</div>
        <h3 class="empty-title">Aucun élève trouvé</h3>
        <p class="empty-text" *ngIf="selectedStudent">
          Aucune donnée de progrès trouvée pour l'élève sélectionné. 
          Essayez de sélectionner un autre élève ou d'effacer les filtres.
        </p>
        <p class="empty-text" *ngIf="!selectedStudent">
          Aucune donnée de progrès d'élève disponible pour les filtres sélectionnés. 
          Essayez d'ajuster vos filtres ou assurez-vous que les élèves ont soumis des exercices.
        </p>
        <button class="create-btn" (click)="clearFilters()">
          <span class="btn-icon">🔄</span>
          Effacer les filtres
        </button>
      </div>
    </div>

    <!-- Onglet Analyses d'exercices -->
    <div *ngIf="activeTab === 'exercises'" class="tab-content">
      <div class="exercises-header">
        <h3 class="section-subtitle">Analyses de mes exercices</h3>
      </div>
      
      <div class="exercises-analytics">
        <div *ngFor="let analyticsData of exerciseAnalytics" class="analytics-card">
          <div class="analytics-header">
            <div class="analytics-info">
              <h4 class="analytics-title">{{ analyticsData.exercise?.title || 'Exercice inconnu' }}</h4>
              <div class="analytics-meta">
                <span class="exercise-type" [class]="analyticsData.exercise?.type">
                  {{ toTitleCase(analyticsData.exercise?.type || 'inconnu') }}
                </span>
                <span class="exercise-difficulty">
                  Exercice
                </span>
              </div>
            </div>
            <div class="analytics-score" [ngClass]="getScoreColor(analyticsData.analytics?.overall?.averageScore || 0)">
              {{ (analyticsData.analytics?.overall?.averageScore || 0).toFixed(1) }}%
            </div>
          </div>

          <div class="analytics-stats">
            <div class="stat">
              <span class="stat-label">Soumissions:</span>
              <span class="stat-value">{{ analyticsData.analytics?.overall?.totalSubmissions || 0 }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Élèves uniques:</span>
              <span class="stat-value">{{ analyticsData.analytics?.overall?.uniqueStudents || 0 }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Temps moyen:</span>
              <span class="stat-value">{{ formatTime(analyticsData.analytics?.overall?.averageTimeSpent || 0) }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Points totaux:</span>
              <span class="stat-value">{{ analyticsData.exercise?.totalPoints || 0 }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- État vide pour l'onglet Exercices -->
      <div *ngIf="exerciseAnalytics.length === 0 && !isLoading" class="empty-state">
        <div class="empty-icon">📊</div>
        <h3 class="empty-title">Aucune analyse d'exercice</h3>
        <p class="empty-text">Vous n'avez pas encore créé d'exercices ou aucun élève ne les a soumis.</p>
      </div>
    </div>

    <!-- État vide général -->
    <div *ngIf="!isLoading && studentsProgressData.length === 0 && activeTab === 'overview'" class="empty-state">
      <div class="empty-icon">📊</div>
      <h3 class="empty-title">Aucune donnée de progrès trouvée</h3>
      <p class="empty-text">Aucune donnée de progrès d'élève disponible. Cela pourrait signifier:</p>
      <ul class="empty-list">
        <li>Vous n'avez pas encore créé d'exercices</li>
        <li>Les élèves n'ont soumis aucun de vos exercices</li>
        <li>Il n'y a pas d'élèves dans vos classes</li>
      </ul>
    </div>
  </div>
</section>
          