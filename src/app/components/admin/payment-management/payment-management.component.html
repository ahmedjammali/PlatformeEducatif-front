<!-- payment-management.component.html (Updated) -->
<div class="payment-management-container">
  <!-- Header Section -->
  <header class="header-section">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <span class="title-icon">💳</span>
          Gestion des Paiements
          <span class="academic-year-badge">{{ currentAcademicYear }}</span>
        </h1>
        <p class="page-subtitle">Gérez les paiements de tous vos étudiants de manière efficace</p>
      </div>
      
      <div class="header-actions">
        <button class="btn btn-financial" (click)="navigateToFinancialOverview()">
          <span class="btn-icon">💰</span>
          Aperçu Financier
        </button>
        <button class="btn btn-config" (click)="navigateToConfig()">
          <span class="btn-icon">⚙️</span>
          Configuration
        </button>
        <button class="btn btn-generate" (click)="bulkGeneratePayments()" [disabled]="isLoading">
          <span class="btn-icon">✨</span>
          Générer en masse
        </button>
        <button class="btn btn-update" (click)="updateExistingPayments()" [disabled]="isLoading" *ngIf="paymentConfig">
          <span class="btn-icon">🔄</span>
          Mettre à jour
        </button>
      </div>
    </div>
  </header>

  <!-- Dashboard Cards -->
  <section class="dashboard-section" *ngIf="dashboard">
    <div class="stats-container">
      <!-- Overview Stats -->
      <div class="stats-grid">
        <div class="stat-card total-students">
          <div class="stat-header">
            <span class="stat-icon">👥</span>
            <span class="stat-label">Total Étudiants</span>
          </div>
          <div class="stat-value">{{ dashboard.overview.totalStudents }}</div>
          <div class="stat-change positive">
            <span class="change-icon">📈</span>
            <span>100% inscrit</span>
          </div>
        </div>

        <div class="stat-card completed-payments">
          <div class="stat-header">
            <span class="stat-icon">✅</span>
            <span class="stat-label">Paiements Complets</span>
          </div>
          <div class="stat-value">{{ dashboard.statusCounts.completed }}</div>
          <div class="stat-change positive">
            <span class="change-icon">📈</span>
            <span>{{ getCompletionRate() }}%</span>
          </div>
        </div>

        <div class="stat-card partial-payments">
          <div class="stat-header">
            <span class="stat-icon">⏱️</span>
            <span class="stat-label">Paiements Partiels</span>
          </div>
          <div class="stat-value">{{ dashboard.statusCounts.partial }}</div>
          <div class="stat-change warning">
            <span class="change-icon">⚠️</span>
            <span>En cours</span>
          </div>
        </div>

        <div class="stat-card overdue-payments">
          <div class="stat-header">
            <span class="stat-icon">❌</span>
            <span class="stat-label">En Retard</span>
          </div>
          <div class="stat-value">{{ dashboard.statusCounts.overdue }}</div>
          <div class="stat-change negative" *ngIf="dashboard.statusCounts.overdue > 0">
            <span class="change-icon">🚨</span>
            <span>Action requise</span>
          </div>
        </div>
      </div>


  <!-- Filters Section -->
  <section class="filters-section">
    <div class="filter-card">
      <div class="filter-header">
        <h3>Filtres & Recherche</h3>
        <button class="btn-clear" (click)="clearFilters()" title="Effacer les filtres">
          <span class="icon">🗑️</span>
        </button>
      </div>
      
      <div class="filter-container">
        <!-- Search Input -->
        <div class="search-field">
          <span class="search-icon">🔍</span>
          <input 
            type="text" 
            [value]="searchControl.value" 
            (input)="onSearchInput($event)"
            placeholder="Rechercher un étudiant..."
            class="search-input">
          <button 
            *ngIf="searchControl.value" 
            (click)="searchControl.setValue('')"
            class="clear-search">
            <span class="icon">✖️</span>
          </button>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
          <div class="form-group">
            <label for="academicYear">Année Académique</label>
            <select 
              id="academicYear"
              [value]="filterForm.get('academicYear')?.value"
              (change)="onAcademicYearChange($event)"
              class="form-select">
              <option *ngFor="let year of academicYears" [value]="year">
                {{ year }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="paymentStatus">Statut de Paiement</label>
            <select 
              id="paymentStatus"
              [value]="filterForm.get('paymentStatus')?.value"
              (change)="onPaymentStatusChange($event)"
              class="form-select">
              <option value="">Tous les statuts</option>
              <option *ngFor="let status of paymentStatuses.slice(1)" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="classGroup">Niveau</label>
            <select 
              id="classGroup"
              [value]="filterForm.get('classGroup')?.value"
              (change)="onClassGroupChange($event)"
              class="form-select">
              <option value="">Tous les niveaux</option>
              <option *ngFor="let group of classGroups.slice(1)" [value]="group.value">
                {{ group.label }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="classId">Classe</label>
            <select 
              id="classId"
              [value]="filterForm.get('classId')?.value"
              (change)="onClassIdChange($event)"
              class="form-select">
              <option value="">Toutes les classes</option>
              <option *ngFor="let class of classes" [value]="class._id">
                {{ class.name }} ({{ class.grade }})
              </option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quick Actions -->
  <section class="quick-actions-section" *ngIf="getQuickActions().length > 0">
    <div 
      class="quick-action" 
      *ngFor="let action of getQuickActions()"
      (click)="action.action()"
      [style.--action-color]="action.color">
      <span class="action-icon">{{ action.icon }}</span>
      <span class="action-text">{{ action.label }}</span>
      <span class="action-label">Voir →</span>
    </div>
  </section>

  <!-- Students Table -->
  <section class="table-section">
    <div class="table-card">
      <div class="table-header">
        <div class="table-title">
          <h2>Liste des Étudiants</h2>
          <div class="status-chips">
            <button 
              *ngFor="let status of paymentStatuses.slice(1)" 
              class="status-chip"
              [class.active]="filterForm.get('paymentStatus')?.value === status.value"
              (click)="filterByStatus(status.value)"
              [style.--chip-color]="status.color">
              <span class="chip-icon">{{ getStatusEmoji(status.value) }}</span>
              <span class="chip-text">{{ getStatusCount(status.value) }}</span>
            </button>
          </div>
        </div>
        
        <div class="table-info">
          <span class="student-count">
            <strong>{{ students.length }}</strong> étudiants
            <span *ngIf="searchControl.value || hasActiveFilters()"> - Filtrés</span>
          </span>
        </div>
      </div>

      <div class="table-container" [class.loading]="isLoading">
        <!-- Loading Overlay -->
        <div class="loading-overlay" *ngIf="isLoading">
          <div class="spinner"></div>
          <p>Chargement des données...</p>
        </div>

        <!-- Students Table -->
        <div class="table-wrapper">
          <table class="payment-table">
            <thead>
              <tr>
                <th class="expand-col"></th>
                <th class="student-col">Étudiant</th>
                <th class="class-col">Classe</th>
                <th class="status-col">Statut</th>
                <th class="financial-col">Informations Financières</th>
                <th class="progress-col">Progression</th>
                <th class="actions-col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let student of students; let i = index">
                <!-- Main Student Row -->
                <tr class="student-row" [class.expanded]="expandedStudentId === student._id">
                  <td class="expand-cell">
                    <button 
                      class="expand-btn"
                      (click)="toggleExpandRow(student)" 
                      [disabled]="!student.hasPaymentRecord">
                      <span class="expand-icon">
                        {{ expandedStudentId === student._id ? '⬆️' : '⬇️' }}
                      </span>
                    </button>
                  </td>
                  
                  <td class="student-cell">
                    <div class="student-info">
                      <div class="student-avatar">
                        <span class="avatar-icon">{{ student.name.charAt(0).toUpperCase() }}</span>
                      </div>
                      <div class="student-details">
                        <div class="student-name">{{ student.name }}</div>
                        <div class="student-email">{{ student.email }}</div>
                      </div>
                    </div>
                  </td>

                  <td class="class-cell">
                    <div class="class-info">
                      <span class="class-name">{{ getClassName(student) }}</span>
                      <span class="class-grade" *ngIf="getClassGrade(student) !== 'Non assigné'">
                        Grade: {{ getClassGrade(student) }}
                      </span>
                      <span 
                        *ngIf="student.classGroup" 
                        class="class-chip"
                        [style.background-color]="getClassGroupColor(student.classGroup)"
                        [style.color]="'white'">
                        {{ getClassGroupLabel(student.classGroup) }}
                      </span>
                    </div>
                  </td>

                  <td class="status-cell">
                    <div 
                      class="status-badge"
                      [class]="'status-' + (student.paymentRecord?.overallStatus || 'no_record')">
                      <span class="status-icon">
                        {{ getStatusEmoji(student.paymentRecord?.overallStatus || 'no_record') }}
                      </span>
                      <span class="status-text">
                        {{ getStatusLabel(student.paymentRecord?.overallStatus || 'no_record') }}
                      </span>
                    </div>
                  </td>

                  <td class="financial-cell">
                    <div class="financial-info" *ngIf="student.paymentRecord">
                      <div class="amount-row">
                        <span class="amount-label">Total:</span>
                        <span class="amount-value total">{{ formatCurrency(student.paymentRecord.totalAmount) }}</span>
                      </div>
                      <div class="amount-row">
                        <span class="amount-label">Payé:</span>
                        <span class="amount-value paid">{{ formatCurrency(student.paymentRecord.paidAmount) }}</span>
                      </div>
                      <div class="amount-row">
                        <span class="amount-label">Restant:</span>
                        <span 
                          class="amount-value remaining" 
                          [class.overdue]="student.paymentRecord.overallStatus === 'overdue'">
                          {{ formatCurrency(student.paymentRecord.remainingAmount) }}
                        </span>
                      </div>
                    </div>
                    <div class="no-record" *ngIf="!student.paymentRecord">
                      <span class="no-record-icon">❓</span>
                      <span>Aucun dossier</span>
                    </div>
                  </td>

                  <td class="progress-cell">
                    <div class="progress-container" *ngIf="student.paymentRecord">
                      <div class="progress-info">
                        <span class="progress-percentage">{{ calculateProgress(student) }}%</span>
                        <div class="progress-bar mini">
                          <div 
                            class="progress-fill"
                            [class]="'progress-' + student.paymentRecord.overallStatus"
                            [style.width.%]="calculateProgress(student)">
                          </div>
                        </div>
                      </div>
                    </div>
                    <span class="no-record" *ngIf="!student.paymentRecord">—</span>
                  </td>

                  <td class="actions-cell">
                    <div class="action-buttons">
                      <!-- Generate Payment Record -->
                      <button 
                        class="action-btn generate"
                        title="Générer dossier de paiement"
                        *ngIf="!student.hasPaymentRecord"
                        (click)="generatePaymentRecord(student)">
                        <span class="btn-icon">➕</span>
                      </button>

                      <!-- Record Monthly Payment -->
                      <button 
                        class="action-btn monthly"
                        title="Enregistrer paiement mensuel"
                        *ngIf="student.hasPaymentRecord && student.paymentRecord?.paymentType === 'monthly'"
                        (click)="openPaymentDialog(student, 'monthly')">
                        <span class="btn-icon">📅</span>
                      </button>

                      <!-- Record Annual Payment -->
                      <button 
                        class="action-btn annual"
                        title="Enregistrer paiement annuel"
                        *ngIf="student.hasPaymentRecord && !student.paymentRecord?.annualPayment?.isPaid"
                        (click)="openPaymentDialog(student, 'annual')">
                        <span class="btn-icon">📋</span>
                      </button>

                      <!-- View Details -->
                      <button 
                        class="action-btn details"
                        title="Voir détails"
                        *ngIf="student.hasPaymentRecord"
                                              (click)="toggleExpandRow(student)" >
                        <span class="btn-icon">👁️</span>
                      </button>

                      <!-- Delete Payment Record -->
                      <button 
                        class="action-btn delete"
                        title="Supprimer dossier"
                        *ngIf="student.hasPaymentRecord"
                        (click)="deletePaymentRecord(student)">
                        <span class="btn-icon">🗑️</span>
                      </button>
                    </div>
                  </td>
                </tr>

                <!-- Expanded Detail Row -->
                <tr 
                  class="expanded-row" 
                  *ngIf="student.paymentRecord && expandedStudentId === student._id"
                  [@detailExpand]="'expanded'">
                  <td colspan="7" class="expanded-cell">
                    <div class="expanded-content">
                      <div class="payment-details">
                        
                        <div class="details-header">
                          <h3>Détails des Paiements - {{ student.name }}</h3>
                          <div class="details-summary">
                            <span class="summary-item">
                              <strong>{{ student.paymentRecord.paymentType === 'annual' ? 'Paiement Annuel' : 'Paiements Mensuels' }}</strong>
                            </span>
                            <span class="summary-item">
                              Année: {{ student.paymentRecord.academicYear }}
                            </span>
                            <span class="summary-item">
                              Groupe: {{ getClassGroupLabel(student.paymentRecord.classGroup) }}
                            </span>
                          </div>
                        </div>
                        
                        <div class="monthly-payments-section" *ngIf="student.paymentRecord.monthlyPayments.length > 0">
                          <h4>Calendrier des Paiements Mensuels</h4>
                          <div class="payments-grid">
                            <div 
                              class="payment-month-card" 
                              *ngFor="let payment of student.paymentRecord.monthlyPayments; let idx = index"
                              [class]="'payment-' + payment.status"
                              [class.overdue]="isPaymentOverdue(payment.dueDate)">
                              
                              <div class="month-header">
                                <div class="month-info">
                                  <span class="month-name">{{ payment.monthName }}</span>
                                  <span class="due-date">Échéance: {{ formatDate(payment.dueDate) }}</span>
                                  <span class="overdue-warning" *ngIf="isPaymentOverdue(payment.dueDate) && payment.status !== 'paid'">
                                    ⚠️ En retard
                                  </span>
                                </div>
                                <span class="status-icon">
                                  {{ getStatusEmoji(payment.status) }}
                                </span>
                              </div>
                              
                              <div class="month-financial">
                                <div class="amount-info">
                                  <span class="amount-due">Dû: {{ formatCurrency(payment.amount) }}</span>
                                  <span class="amount-paid" *ngIf="payment.paidAmount > 0">
                                    Payé: {{ formatCurrency(payment.paidAmount) }}
                                  </span>
                                  <span class="amount-remaining" *ngIf="payment.paidAmount < payment.amount">
                                    Restant: {{ formatCurrency(payment.amount - payment.paidAmount) }}
                                  </span>
                                </div>
                                
                                <div class="payment-info" *ngIf="payment.paymentDate">
                                  <span class="payment-date">{{ formatDate(payment.paymentDate) }}</span>
                                  <span class="payment-method">{{ getPaymentMethodLabel(payment.paymentMethod) }}</span>
                                  <span class="receipt-number" *ngIf="payment.receiptNumber">
                                    Reçu: {{ payment.receiptNumber }}
                                  </span>
                                </div>
                              </div>

                              <div class="month-actions" *ngIf="payment.status !== 'paid'">
                                <button 
                                  class="btn btn-small pay-btn"
                                  (click)="openPaymentDialog(student, 'monthly', idx)">
                                  <span class="btn-icon">💳</span>
                                  {{ payment.status === 'partial' ? 'Compléter' : 'Payer' }}
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="annual-payment-section" *ngIf="student.paymentRecord.annualPayment?.isPaid">
                          <h4>Paiement Annuel</h4>
                          <div class="annual-payment-info">
                            <div class="annual-details">
                              <span><strong>Méthode:</strong> {{ getPaymentMethodLabel(student.paymentRecord.annualPayment?.paymentMethod) }}</span>
                              <span *ngIf="student.paymentRecord.annualPayment?.discount">
                                <strong>Remise:</strong> {{ formatCurrency(student.paymentRecord.annualPayment?.discount || 0) }}
                              </span>
                              <span *ngIf="student.paymentRecord.annualPayment?.receiptNumber">
                                <strong>Reçu:</strong> {{ student.paymentRecord.annualPayment?.receiptNumber }}
                              </span>
                              <span *ngIf="student.paymentRecord.annualPayment?.notes">
                                <strong>Notes:</strong> {{ student.paymentRecord.annualPayment?.notes }}
                              </span>
                            </div>
                          </div>
                        </div>

                        <!-- Payment Summary -->
                        <div class="payment-summary">
                          <div class="summary-stats">
                            <div class="summary-stat">
                              <span class="stat-label">Montant Total</span>
                              <span class="stat-value">{{ formatCurrency(student.paymentRecord.totalAmount) }}</span>
                            </div>
                            <div class="summary-stat">
                              <span class="stat-label">Montant Payé</span>
                              <span class="stat-value paid">{{ formatCurrency(student.paymentRecord.paidAmount) }}</span>
                            </div>
                            <div class="summary-stat">
                              <span class="stat-label">Montant Restant</span>
                              <span class="stat-value remaining">{{ formatCurrency(student.paymentRecord.remainingAmount) }}</span>
                            </div>
                            <div class="summary-stat">
                              <span class="stat-label">Progression</span>
                              <span class="stat-value">{{ calculateProgress(student) }}%</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>

          <!-- No Data State -->
          <div class="no-data-state" *ngIf="!isLoading && students.length === 0">
            <div class="no-data-content">
              <span class="no-data-icon">🎓</span>
              <h3>Aucun étudiant trouvé</h3>
              <p *ngIf="hasActiveFilters()">Essayez de modifier vos filtres de recherche</p>
              <p *ngIf="!hasActiveFilters()">Aucun étudiant n'est encore inscrit</p>
              <button class="btn btn-primary" (click)="clearFilters()" *ngIf="hasActiveFilters()">
                Effacer les filtres
              </button>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="table-footer">
          <div class="pagination">
            <button 
              class="pagination-btn"
              [disabled]="currentPage <= 1"
              (click)="goToPage(currentPage - 1)">
              ◀️ Précédent
            </button>
            
            <span class="pagination-info">
              Page {{ currentPage }} sur {{ totalPages }}
              ({{ totalStudents }} étudiants au total)
            </span>
            
            <button 
              class="pagination-btn"
              [disabled]="currentPage >= totalPages"
              (click)="goToPage(currentPage + 1)">
              Suivant ▶️
            </button>
          </div>
          
          <div class="page-size-selector">
            <label for="pageSize">Éléments par page:</label>
            <select 
              id="pageSize"
              [value]="pageSize"
              (change)="onPageSizeChange($event)"
              class="page-size-select">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Payment Dialog Modal -->
  <div class="modal-overlay" *ngIf="isPaymentDialogOpen" (click)="closePaymentDialog()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <app-payment-dialog
        *ngIf="currentDialogData"
        [data]="currentDialogData"
        (dialogClosed)="closePaymentDialog($event)">
      </app-payment-dialog>
    </div>
  </div>
</div>